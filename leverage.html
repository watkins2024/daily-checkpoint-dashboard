const financial = store.get('lev.financial', { savings: 0, monthlyExpenses: 0, baselineExpenses: 0 });
  document.getElementById('totalSavings').value = financial.savings || '';
  document.getElementById('monthlyExpenses').value = financial.monthlyExpenses || '';
  updateFinancials();
}

function deleteIncomeStream(i) {
  const streams = store.get('lev.incomeStreams', []);
  streams.splice(i, 1);
  store.set('lev.incomeStreams', streams);
  renderIncomeStreams();
  updateTopMetrics();
}

function saveIncomeEvent() {
  const source = document.getElementById('incomeEventSource').value.trim();
  const amount = parseFloat(document.getElementById('incomeEventAmount').value) || 0;
  const notes = document.getElementById('incomeEventNotes').value.trim();
  
  if (!source || amount <= 0) {
    alert('Please enter source and amount');
    return;
  }
  
  const events = store.get('lev.incomeEvents', []);
  events.unshift({
    id: Date.now(),
    date: new Date().toISOString(),
    source,
    amount,
    notes
  });
  store.set('lev.incomeEvents', events);
  
  document.getElementById('incomeEventSource').value = '';
  document.getElementById('incomeEventAmount').value = '';
  document.getElementById('incomeEventNotes').value = '';
  closeModal('incomeModal');
}

function updateFinancials() {
  const savings = parseFloat(document.getElementById('totalSavings').value) || 0;
  const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
  
  const financial = store.get('lev.financial', { savings: 0, monthlyExpenses: 0, baselineExpenses: monthlyExpenses || 0 });
  
  // Set baseline on first save
  if (!financial.baselineExpenses && monthlyExpenses > 0) {
    financial.baselineExpenses = monthlyExpenses;
  }
  
  financial.savings = savings;
  financial.monthlyExpenses = monthlyExpenses;
  store.set('lev.financial', financial);
  
  // Calculate metrics
  const streams = store.get('lev.incomeStreams', []);
  const totalIncome = streams.reduce((sum, s) => sum + s.amount, 0);
  const independentIncome = streams.filter(s => s.type === 'independent').reduce((sum, s) => sum + s.amount, 0);
  
  const cashflowRatio = totalIncome > 0 ? ((independentIncome / totalIncome) * 100).toFixed(0) : 0;
  document.getElementById('cashflowRatio').textContent = cashflowRatio + '%';
  
  // Cost reduction
  const costReduction = financial.baselineExpenses > 0 
    ? (((financial.baselineExpenses - monthlyExpenses) / financial.baselineExpenses) * 100).toFixed(0)
    : 0;
  document.getElementById('costReduction').textContent = Math.max(0, costReduction) + '%';
  
  updateTopMetrics();
}

// Reflection
function saveReflection() {
  const text = document.getElementById('reflectionText').value.trim();
  if (!text) return;
  
  const reflections = store.get('lev.reflections', []);
  reflections.unshift({
    id: Date.now(),
    date: new Date().toISOString(),
    text
  });
  store.set('lev.reflections', reflections);
  
  document.getElementById('reflectionText').value = '';
  closeModal('reflectionModal');
  renderReflections();
}

function renderReflections() {
  const reflections = store.get('lev.reflections', []);
  if (reflections.length === 0) {
    document.getElementById('reflectionList').innerHTML = '<p style="color:#888">No reflections yet.</p>';
    return;
  }
  
  const html = reflections.map((ref, i) => `
    <div style="background: #333; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
      <div style="font-weight: 600; color: #4a9eff; margin-bottom: 8px;">${new Date(ref.date).toLocaleDateString()}</div>
      <div style="line-height: 1.6;">${ref.text}</div>
      <button class="btn btn-sm btn-ghost" onclick="deleteReflection(${i})" style="margin-top: 8px;">Delete</button>
    </div>
  `).join('');
  document.getElementById('reflectionList').innerHTML = html;
}

function deleteReflection(i) {
  if (!confirm('Delete this reflection?')) return;
  const reflections = store.get('lev.reflections', []);
  reflections.splice(i, 1);
  store.set('lev.reflections', reflections);
  renderReflections();
}

// Top Metrics
function updateTopMetrics() {
  // Weighted Autonomy Score
  const metrics = store.get('lev.metrics', defaultMetrics);
  const totalWeight = metrics.reduce((sum, m) => sum + m.weight, 0);
  const weightedProgress = metrics.reduce((sum, m) => sum + (m.progress * m.weight), 0);
  const autonomyScore = totalWeight > 0 ? Math.round(weightedProgress / totalWeight) : 0;
  document.getElementById('autonomyScore').textContent = autonomyScore + '%';
  
  // Independent Income %
  const streams = store.get('lev.incomeStreams', []);
  const totalIncome = streams.reduce((sum, s) => sum + s.amount, 0);
  const independentIncome = streams.filter(s => s.type === 'independent').reduce((sum, s) => sum + s.amount, 0);
  const independentPercent = totalIncome > 0 ? Math.round((independentIncome / totalIncome) * 100) : 0;
  document.getElementById('independentIncome').textContent = independentPercent + '%';
  
  // Months Runway
  const financial = store.get('lev.financial', { savings: 0, monthlyExpenses: 0 });
  const monthsRunway = financial.monthlyExpenses > 0 
    ? (financial.savings / financial.monthlyExpenses).toFixed(1)
    : 0;
  document.getElementById('monthsRunway').textContent = monthsRunway;
  
  // Resilience Index
  const repairSkills = parseInt(document.getElementById('repairSkills')?.value || 0);
  const exchangePartners = parseInt(document.getElementById('exchangePartners')?.value || 0);
  const resilienceIndex = streams.length + repairSkills + exchangePartners;
  document.getElementById('resilienceIndex').textContent = resilienceIndex;
}

function exportData() {
  const data = {
    metrics: store.get('lev.metrics', defaultMetrics),
    actions: store.get('lev.actions', []),
    incomeStreams: store.get('lev.incomeStreams', []),
    incomeEvents: store.get('lev.incomeEvents', []),
    financial: store.get('lev.financial', {}),
    reflections: store.get('lev.reflections', []),
    exportDate: new Date().toISOString(),
    topMetrics: {
      autonomyScore: document.getElementById('autonomyScore').textContent,
      independentIncome: document.getElementById('independentIncome').textContent,
      monthsRunway: document.getElementById('monthsRunway').textContent,
      resilienceIndex: document.getElementById('resilienceIndex').textContent,
      cashflowRatio: document.getElementById('cashflowRatio')?.textContent || '0%'
    }
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `leverage-data-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  alert('Data exported! Import into Excel or Google Sheets for analysis.');
}

// Initialize
renderMetrics();
renderActions();
renderIncomeStreams();
renderReflections();
updateTopMetrics();
</script>

</body>
</html>
