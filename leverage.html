<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Independence Laboratory — Scalable Ops (Dark)</title>
  <style>
    /* ------------------------------------------------------
       Independence Laboratory v4 — Scalable Ops (Dark)
       Tailored for: Airbnb Host Support (restock + yard + photo report)
       Goals:
       - Quiet, elegant UI (low noise)
       - One crystal-clear next step from a deep, practical library
       - "Gentle" vs "Push" modes (small move vs leverage jump)
       - Steps are concrete, revenue-true, and sequence toward scale
       - Keeps your existing localStorage data/keys
       ------------------------------------------------------ */

    :root{
      --bg: #0b0f14;
      --surface: #0f151c;
      --muted: #92a0b3;
      --ink: #e7edf7;
      --edge: #1d2938;
      --accent: #53a8ff;
      --accent-2: #7c8cff;
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ring: rgba(83,168,255,.22);
      --radius: 14px;
      --shadow: 0 8px 28px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 80% -10%, #0d131a 0%, #0b0f14 45%, #0b0f14 100%);
      color: var(--ink);
    }

    a{color:var(--muted); text-decoration:none}
    .top-nav{ position:sticky; top:0; z-index:30; background:#080c10cc; backdrop-filter: blur(8px); border-bottom: 1px solid #0f1720; display:flex; gap:10px; padding:10px 16px }
    .top-nav a{ padding:8px 12px; border-radius:10px }
    .top-nav a:hover{ background:#12161c; color: var(--accent) }
    .top-nav a.active{ background:#12161c; color: var(--accent) }

    .shell{ display:grid; grid-template-columns: 280px 1fr; gap:16px; max-width:1200px; margin:18px auto 40px; padding:0 16px }

    /* Sidebar */
    .side{ background: var(--surface); border:1px solid var(--edge); border-radius: var(--radius); box-shadow: var(--shadow); padding:10px }
    .side h2{ font-size:14px; color:var(--muted); margin:4px 6px 10px }

    .metric-item{ display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; cursor:pointer }
    .metric-item:hover{ background:#0d131a }
    .metric-item.active{ background:#0d1520; outline: 1px solid #142033 }

    .ring{ width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-size:11px; font-weight:700; color:#9be2c2; background:
      conic-gradient(var(--ok) var(--pct,0%), #142033 0); }

    .item-text{ display:grid }
    .item-name{ font-size:13px }
    .item-sub{ font-size:11px; color:var(--muted) }

    /* Main */
    .main{ display:grid; gap:16px }

    .card{ background: var(--surface); border:1px solid var(--edge); border-radius: var(--radius); box-shadow: var(--shadow); padding:18px }
    .card h1{ font-size:22px; margin:0 0 4px }
    .muted{ color: var(--muted) }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .grow{ flex:1 1 280px }

    .badge{ font-size:12px; color:#a6b3c6; background:#0d1520; border:1px solid #16263a; border-radius:999px; padding:4px 10px }

    .bar{ height:12px; width:100%; background:#0e1621; border:1px solid #142033; border-radius:999px; position:relative; overflow:hidden }
    .bar-fill{ position:absolute; inset:0 auto 0 0; width:0%; background: linear-gradient(90deg, #12b886, #53a8ff); transition: width .35s ease }
    .bar-line{ position:absolute; left:60%; top:-4px; height:20px; width:2px; background: var(--warn) }

    input, textarea, select{ width:100%; padding:10px 12px; border-radius:10px; background:#0c121a; border:1px solid #142033; color:var(--ink) }
    input:focus, textarea:focus, select:focus{ outline:none; border-color: #214b7a; box-shadow: 0 0 0 3px var(--ring) }

    .btn{ background:#112136; border:1px solid #1b3a5c; color:#cfe4ff; padding:10px 14px; border-radius:10px; cursor:pointer }
    .btn:hover{ background:#0f1c2e }
    .btn-ok{ background:#0f2a22; border:1px solid #155a48; color:#bff2df }
    .btn-ghost{ background:transparent; border:1px dashed #203246; color:var(--muted) }

    .step{ background:#0c121a; border:1px solid #132035; padding:14px; border-radius:12px; display:grid; gap:8px }
    .step-title{ font-weight:700; letter-spacing:.2px }
    .step-help{ font-size:12px; color:var(--muted) }

    .mini{ font-size:12px; color:var(--muted) }

    .log{ background:#0c121a; border:1px solid #142033; padding:10px; border-radius:10px; margin-bottom:8px }
    .log .when{ color:#6aa8ff; font-size:12px; margin-bottom:4px }
  </style>
</head>
<body>
  <div class="top-nav">
    <a href="index.html">← Hub</a>
    <a href="walks.html">Walks</a>
    <a href="work.html">Work</a>
    <a href="business.html">Business</a>
    <a href="leverage.html" class="active">Leverage</a>
  </div>

  <div class="shell">
    <!-- Sidebar: pick a pathway (quiet) -->
    <aside class="side">
      <h2>Your pathways</h2>
      <div id="sideList"></div>
    </aside>

    <!-- Main focus panel: ONE metric at a time -->
    <main class="main">
      <section class="card">
        <h1 id="metricTitle">—</h1>
        <div class="row">
          <span id="metricStage" class="badge">Stage —</span>
          <span id="metricWeight" class="badge">Weight ×</span>
          <span class="badge" id="modeBadge">Mode: Gentle</span>
          <span class="mini">Do the next step → log a proof. Sequences unlock bigger moves.</span>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="grow">
            <div class="bar"><div id="overallFill" class="bar-fill"></div><div class="bar-line" title="Exit baseline (60%)"></div></div>
            <div class="mini" id="overallText" style="margin-top:6px">Overall independence: 0%</div>
          </div>
          <div class="badge" id="streakBadge">Streak 0w</div>
        </div>
      </section>

      <section class="card">
        <div class="row" style="align-items:center; justify-content: space-between">
          <div class="row" style="align-items:center">
            <div id="metricRing" class="ring" style="--pct:0%">0%</div>
            <div class="mini" id="milestoneSummary">0/5 milestones</div>
          </div>
          <label class="mini" style="display:flex; align-items:center; gap:8px">
            <input type="checkbox" id="pushToggle" onchange="toggleMode()" /> Push mode
          </label>
        </div>

        <!-- Next attainable step (from library) -->
        <div class="step">
          <div class="step-title" id="stepTitle">Next step will appear here</div>
          <div class="step-help" id="stepHelp">Small, do‑able and revenue‑true. When done, tick ✓ and (optionally) log one line of proof.</div>
          <div class="row">
            <button class="btn-ok" onclick="completeStep()">✓ I did this</button>
            <button class="btn" onclick="shuffleStep()">↻ Try another option</button>
            <button class="btn-ghost" onclick="markMilestoneIfReady()">Mark milestone ✓</button>
          </div>
          <div class="row">
            <input id="evidenceInput" placeholder="One factual line of proof (optional)" />
            <button class="btn" onclick="saveEvidenceLine()">Save proof</button>
          </div>
        </div>

        <!-- Evidence recap (last 4) -->
        <div id="evidenceList"></div>
      </section>

      <section class="card">
        <h1 style="font-size:16px; margin-bottom:8px">Recent actions</h1>
        <div id="actionList"></div>
      </section>
    </main>
  </div>

  <script>
    /* ===================== Storage ===================== */
    const store = { get(k, d){ try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)) } };

    // Keys preserved from your prior versions
    // - lev.ladder, lev.actions, lev.evidence, lev.energy, lev.thread, lev.micro
    // New lightweight ones for v4
    // - lev.mode       ('gentle' | 'push')
    // - lev.focus      (metric index)
    // - lev.progress.<Metric>.<Stage>: count of steps done (auto-complete milestone at threshold)

    /* ===================== Ladder ===================== */
    const defaultLadder = [
      { name:'Independent Cashflow (Airbnb Ops)', weight:4, milestones:[
        {stage:'Seed',    text:'Validate one paying client at $300–$400/mo', completed:false},
        {stage:'Active',  text:'Standardise the offer + route and reporting', completed:false},
        {stage:'Growing', text:'Reach $1,200+/mo with 3 clients', completed:false},
        {stage:'Stable',  text:'Document ops and hire a helper 5–10 hrs/wk', completed:false},
        {stage:'Autonomous', text:'Owner-time ≤ 10 hrs/mo; keep margin ≥ 40%', completed:false}
      ]},
      { name:'Survival Buffer', weight:3, milestones:[
        {stage:'Seed',    text:'Open “Runway” account + first transfer', completed:false},
        {stage:'Active',  text:'1 month essentials funded', completed:false},
        {stage:'Growing', text:'3 months funded', completed:false},
        {stage:'Stable',  text:'6 months funded', completed:false},
        {stage:'Autonomous', text:'12+ months + written rules of use', completed:false}
      ]},
      { name:'Lean Cost Index (Family Cash Design)', weight:2, milestones:[
        {stage:'Seed',    text:'Move 3 recurring bills to better/cheaper', completed:false},
        {stage:'Active',  text:'Create simple “Money Map” (no budget)', completed:false},
        {stage:'Growing', text:'Lower baseline by 10%', completed:false},
        {stage:'Stable',  text:'Lower baseline by 20%', completed:false},
        {stage:'Autonomous', text:'Maintain lean baseline 6+ months', completed:false}
      ]},
      { name:'Productised Value (Add‑on Offers)', weight:3, milestones:[
        {stage:'Seed',    text:'Define 1 add-on (kit or mini‑service)', completed:false},
        {stage:'Active',  text:'Sell first add‑on to an existing client', completed:false},
        {stage:'Growing', text:'$300+/mo from add‑ons', completed:false},
        {stage:'Stable',  text:'Automate ordering + delivery', completed:false},
        {stage:'Autonomous', text:'2–3 add‑ons running with SOP', completed:false}
      ]},
      { name:'Exchange Network', weight:2, milestones:[
        {stage:'Seed',    text:'Create list of 10 complementary partners', completed:false},
        {stage:'Active',  text:'Do 2 partner exchanges (referrals ↔ perks)', completed:false},
        {stage:'Growing', text:'5 active partners feeding leads', completed:false},
        {stage:'Stable',  text:'1 partner contract/month min', completed:false},
        {stage:'Autonomous', text:'Weekly lead flow via partners', completed:false}
      ]},
      { name:'Systems Autonomy', weight:2, milestones:[
        {stage:'Seed',    text:'Back up ops + create a one‑page SOP', completed:false},
        {stage:'Active',  text:'Simple CRM + route schedule live', completed:false},
        {stage:'Growing', text:'Photo report template + auto-send', completed:false},
        {stage:'Stable',  text:'Checklist app + shared calendar', completed:false},
        {stage:'Autonomous', text:'Ops run if you step away 4 weeks', completed:false}
      ]},
      { name:'Multi-Source Income', weight:3, milestones:[
        {stage:'Seed',    text:'Add one small remote/online stream', completed:false},
        {stage:'Active',  text:'Earn from 2 sources in one month', completed:false},
        {stage:'Growing', text:'Maintain 3 active streams', completed:false},
        {stage:'Stable',  text:'4+ reliable payers', completed:false},
        {stage:'Autonomous', text:'No source >40% of income', completed:false}
      ]},
      { name:'Physical Base', weight:2, milestones:[
        {stage:'Seed',    text:'Choose a low‑friction service radius', completed:false},
        {stage:'Active',  text:'Lock a route plan (drive time < 45m)', completed:false},
        {stage:'Growing', text:'Secure storage + supplies area', completed:false},
        {stage:'Stable',  text:'Base established and profitable', completed:false},
        {stage:'Autonomous', text:'Ops independent of a single location', completed:false}
      ]},
      { name:'Compliance Mastery (AU)', weight:2, milestones:[
        {stage:'Seed',    text:'ABN + basic insurance confirmed', completed:false},
        {stage:'Active',  text:'BAS/tax set‑aside % and workflow', completed:false},
        {stage:'Growing', text:'Quarterly obligations unaided', completed:false},
        {stage:'Stable',  text:'Confident across tax/insurance processes', completed:false},
        {stage:'Autonomous', text:'Documented checklist + help someone', completed:false}
      ]},
      { name:'Strategic Redundancy', weight:1, milestones:[
        {stage:'Seed',    text:'Duplicate phone tools + contacts', completed:false},
        {stage:'Active',  text:'Backup power + comms', completed:false},
        {stage:'Growing', text:'Spare mower/consumables pack', completed:false},
        {stage:'Stable',  text:'All essential gear covered', completed:false},
        {stage:'Autonomous', text:'Survives any single failure', completed:false}
      ]},
      { name:'Repair Capability', weight:1, milestones:[
        {stage:'Seed',    text:'Learn basic mower maintenance', completed:false},
        {stage:'Active',  text:'Sharpen/replace blades yourself', completed:false},
        {stage:'Growing', text:'Fix 2 common small issues solo', completed:false},
        {stage:'Stable',  text:'3 verified competencies', completed:false},
        {stage:'Autonomous', text:'Teach or document for helper', completed:false}
      ]},
      { name:'Reflection Loop', weight:2, milestones:[
        {stage:'Seed',    text:'Write one weekly reflection', completed:false},
        {stage:'Active',  text:'4 reflections in a row', completed:false},
        {stage:'Growing', text:'Spot one pattern from notes', completed:false},
        {stage:'Stable',  text:'Weekly review automatic', completed:false},
        {stage:'Autonomous', text:'Reflections guide decisions', completed:false}
      ]}
    ];

    function loadLadder(){
      const current = store.get('lev.ladder', null); if(!current) return defaultLadder;
      const byName = Object.fromEntries(defaultLadder.map(m=>[m.name, m]));
      return current.map(old=>{
        const tpl = byName[old.name] || old;
        const merged = (tpl.milestones||[]).map(t=>{
          const match = (old.milestones||[]).find(o=>o.text===t.text) || {}; return {...t, completed: !!match.completed};
        });
        return { name: old.name, weight: tpl.weight||old.weight||1, milestones: merged };
      });
    }

    // ---- One-time name migration to map your older metric names to the new step libraries ----
    const NAME_ALIASES = {
      'Independent Cashflow': 'Independent Cashflow (Airbnb Ops)',
      'Lean Cost Index': 'Lean Cost Index (Family Cash Design)',
      'Productised Value': 'Productised Value (Add‑on Offers)',
      'Compliance Mastery': 'Compliance Mastery (AU)'
    };
    function migrateNames(list){
      const seen = new Set();
      return list.map(m => {
        const target = NAME_ALIASES[m.name] || m.name; // if alias exists, rename to target
        // prevent duplicate entries if user already has both old and new
        const uniqueName = seen.has(target) ? m.name : target;
        seen.add(uniqueName);
        return { ...m, name: uniqueName };
      });
    }
    /* ===================== Evidence-based Step Library ===================== */
    // Structure: steps[metric][stage] = { gentle: [...], push: [...] }
    // Concrete, field-tested. Focused on Airbnb Host Support business.
    const steps = {
      'Independent Cashflow (Airbnb Ops)':{
        'Seed':{
          gentle:[
            'Define the service in 1 sentence: restock + light yard + photo report (no cleaning).',
            'Price test: set $350/mo for 4 visits (weekly) within 15km radius.',
            'Create a 6‑photo proof template: exterior, entry, kitchen, bath, bedroom, supplies.',
            'Draft a 4‑line outreach email for hosts (pain→offer→price→reply).',
            'Make a list of 10 local listings that clearly need upkeep (save URLs).',
            'Register a simple domain and placeholder page with contact form.',
            'Set up payment link (Stripe/PayPal) named “Airbnb Restock & Report — Monthly”.',
            'Create a one‑page service agreement (scope, visits, access, price, cancellation).',
            'Prepare a restock checklist: toiletries, coffee/tea, bin liners, basic pantry, batteries.',
            'Assemble a starter kit box (consumables + small tools).'
          ],
          push:[
            'Send 10 direct emails to hosts with your 4‑line pitch and 1 before/after photo.',
            'Post offer once in 2 local FB/host groups (clear scope and price).',
            'Call 2 local cleaning companies to offer “between‑clean restock + yard” partnership.',
            'Offer first month at $300 for 1 early client; include photo report and supply receipts.',
            'Book access with 1 host; schedule 4 weekly visits; lock in keys/lockbox code.'
          ]
        },
        'Active':{
          gentle:[
            'Standardise your weekly route: cluster visits by area, total drive < 90m.',
            'Create a repeatable Google Doc report template with photo slots + notes.',
            'Track time per visit this week (door‑to‑door).',
            'Add a “refill cost cap” (e.g., up to $30/wk, billed monthly with receipts).',
            'Collect 1 testimonial with photos from your first client.'
          ],
          push:[
            'Upsell a simple add‑on: lawn mow (small yard) +$40/visit or bin service +$15.',
            'Publish a basic website section: pricing, route radius map, report sample, payment link.',
            'Email 15 more hosts with your testimonial and report sample.',
            'Partner deal: cleaners refer you; you refer them; 10% off first month both ways.',
            'Create a shared calendar with client: scheduled visit window + locker access notes.'
          ]
        },
        'Growing':{
          gentle:[
            'Raise new‑client price to $400/mo with add‑on menu.',
            'Document supply list with per‑unit cost; set a monthly restock budget.',
            'Batch buy top 10 consumables; store them in labelled bins.',
            'Design a simple route sheet for a helper (address, tasks, photo angles).',
            'Add automatic payment: monthly subscription (Stripe/PayPal subs).'
          ],
          push:[
            'Close 2 more clients from partner referrals or emails (target 3 total).',
            'Pilot a helper for 2 visits; measure quality with your photo report template.',
            'Implement access redundancy: spare keys + lockbox + digital codes list.',
            'Negotiate a small storage shelf at one client’s property for supplies.',
            'Create a “host onboarding” form (access, bins day, lawn frequency, supply preferences).'
          ]
        },
        'Stable':{
          gentle:[
            'Create a 1‑page SOP: visit flow (arrive → restock → yard → photos → notes → leave).',
            'Write a failure protocol (lock jam, missing supplies, guest damage).',
            'Automate monthly invoice + receipts email.',
            'Set weekly office hour for scheduling + stock ordering.',
            'Add a simple CRM sheet: client name, address, visit day, add‑ons, notes.'
          ],
          push:[
            'Hire a reliable helper for 5–10 hrs/week; train using your SOP + photo template.',
            'Offer a 3‑month prepay at 10% discount to improve cashflow.',
            'Add SMS reminders to clients 24h before visits.',
            'Track margin per client; prune or reprice low‑margin ones.',
            'Test a second micro‑area (another 15km cluster) with 1 new client.'
          ]
        },
        'Autonomous':{
          gentle:[
            'Owner dashboard: visits completed this week, issues, cash in/out, margin.',
            'Monthly quality review: sample 1 report per client.',
            'Document “when to pause/exit a client” rules.'
          ],
          push:[
            'Appoint a lead helper; shift scheduling + stock ordering to them.',
            'Package your system as a local franchise‑lite playbook for a new operator.',
            'Spin a second city/cluster with the same SOP and pricing.'
          ]
        }
      },

      'Productised Value (Add‑on Offers)':{
        'Seed':{
          gentle:[
            'Define 1 add‑on: “Mid‑stay mini‑refresh” (trash + quick tidy + supplies).',
            'Create a laminated “welcome restock kit” list with per‑unit costs.',
            'Add a $15 “bin put‑out & bring‑in” weekly add‑on.'
          ],
          push:[
            'Bundle: $60/month for bin service + porch sweep + mail check.',
            'Offer seasonal yard tidy (leaves/rake) for +$45 per visit.',
            'Create listing‑photo touch‑up: 10 photos post‑processing $79.'
          ]
        },
        'Active':{
          gentle:[
            'Pitch add‑on to existing client via email with 2 bullet benefits.',
            'Make a one‑click add‑on payment link.',
            'Track add‑on uptake rate.'
          ],
          push:[
            'Launch add‑on menu on website with photos.',
            'Run a “first month half‑price add‑on” for current clients.',
            'Partner with cleaners to resell your mid‑stay mini‑refresh.'
          ]
        },
        'Growing':{
          gentle:[
            'Hit consistent $300/mo add‑on revenue.',
            'Create reorder reminders for supplies.',
            'Add a small premium starter kit for new hosts.'
          ],
          push:[
            'Negotiate wholesale on consumables to raise margin 10–15%.',
            'Prepack 3 kits for quick dispatch days.',
            'Offer a quarterly “deep yard spruce” day at a fixed rate.'
          ]
        },
        'Stable':{
          gentle:[ 'Automate add‑on billing', 'SOP for add‑on delivery', 'Quarterly review' ],
          push:[ 'Partner commissions for add‑on referrals', 'Run seasonal promos', 'Upsell package at renewal' ]
        },
        'Autonomous':{
          gentle:[ 'Add‑ons run without you', 'Monitor uptake KPI', 'Refine margins annually' ],
          push:[ 'Productise kits for other operators', 'License your menu', 'Open a tiny webshop' ]
        }
      },

      'Systems Autonomy':{
        'Seed':{
          gentle:[ 'Back up SOP + stock list to Drive', 'Create shared calendar', 'Make photo template folder' ],
          push:[ 'Simple CRM (Sheet) with status', 'Issue tracker (lost key, damage)', 'Route planner doc' ]
        },
        'Active':{
          gentle:[ 'Automate invoice emails', 'Create access doc (codes/keys)', 'Set weekly schedule block' ],
          push:[ 'Try a checklist app for visits', 'Auto‑rename photo sets per visit', 'Shared inbox alias' ]
        },
        'Growing':{
          gentle:[ 'Helper onboarding doc', 'Stock reorder cadence', 'Quality review template' ],
          push:[ 'Auto‑send report to host', 'SMS visit reminder', 'SLA response times' ]
        },
        'Stable':{
          gentle:[ 'Calendar + checklist fully used', 'Backups verified', 'Escalation rules' ],
          push:[ 'Lead helper controls schedule', 'You approve exceptions only', 'Quarterly ops drill' ]
        },
        'Autonomous':{
          gentle:[ 'Monthly ops snapshot', 'Risk register', 'Post‑mortem once/quarter' ],
          push:[ 'Document for replication', 'Spin second cluster', 'Delegate ordering & hiring' ]
        }
      },

      'Lean Cost Index (Family Cash Design)':{
        'Seed':{
          gentle:[ 'List top 5 recurring bills + due dates', 'Switch one to cheaper plan', 'Cancel one unused subscription' ],
          push:[ 'Call to negotiate a discount on internet/power', 'Move two bills to annual save', 'Sell one unused item and retire a bill' ]
        },
        'Active':{
          gentle:[ 'Create a 1‑page Money Map: inflow → fixed → variable → buffer → independence', 'Set automatic transfer to buffer', 'Add a “business ops” line for stock' ],
          push:[ 'Cut one category 15% for 30 days', 'Replace 2 retail buys with wholesale', 'Share Money Map with partner' ]
        },
        'Growing':{
          gentle:[ 'Track new baseline for 4 weeks', 'Direct savings to buffer or margin', 'Audit utilities once' ],
          push:[ 'Drop baseline by 10%', 'Refinance or switch one provider', 'Batch errands to cut fuel 15%' ]
        },
        'Stable':{ gentle:[ 'Hold the 20% reduction', 'Automate bills', 'Quarterly review' ], push:[ 'Prepay to capture discounts', 'Bundle services', 'Eliminate one whole category' ] },
        'Autonomous':{ gentle:[ 'Write lean rules', 'Keep one treat', 'Annual review' ], push:[ 'Crisis budget simulation', 'Top up crisis buffer', 'Teach your method' ] }
      },

      'Survival Buffer':{
        'Seed':{ gentle:[ 'Open high‑interest saver', 'Move $50 today', 'Name it “Runway”' ], push:[ 'Move $200 today', 'Redirect one cancelled bill to saver', 'Sell one item and bank it' ] },
        'Active':{ gentle:[ 'Tally one‑month essentials', 'Set weekly auto‑transfer', 'Track months of runway' ], push:[ 'Auto‑transfer 5% of income', 'Cut one big cost 30 days', 'Feed buffer with add‑on sales' ] },
        'Growing':{ gentle:[ 'Add $50 this week', 'Plan next $200', 'Snapshot current balance' ], push:[ 'Add $200 this week', 'Renegotiate a bill', 'Bank next invoice % to buffer' ] },
        'Stable':{ gentle:[ 'Top up to goal', 'Review safety of account', 'Document rules of use' ], push:[ 'Increase to 6 months', 'Move excess appropriately', 'Set alert if dips' ] },
        'Autonomous':{ gentle:[ 'Quarterly review', 'Keep auto‑transfer', 'Rebalance yearly' ], push:[ 'Raise goal by 1 month', 'Shift to better yield', 'Fund resilience item' ] }
      },

      'Exchange Network':{
        'Seed':{ gentle:[ 'List 10 partners: cleaners, lawn, locksmiths, handymen', 'Write a 3‑line referral swap', 'Intro yourself to 2 cleaners' ], push:[ 'Set a 10% mutual referral deal with 1 cleaner', 'Offer to cover mid‑week gaps for a host manager', 'Post partnership call in a local group' ] },
        'Active':{ gentle:[ 'Do 1 barter (you restock, they refer)', 'Share your report template with a partner', 'Log partner details in CRM' ], push:[ 'Co‑bundle “between‑clean” package', 'Ask 2 partners for 3 intros each', 'Run a joint promo week' ] },
        'Growing':{ gentle:[ 'Track lead sources', 'Thank‑you gift for referrals', 'Monthly partner check‑in' ], push:[ 'Formalise 3 partners', 'Guaranteed 1 referral/month deal', 'Cross‑link websites' ] },
        'Stable':{ gentle:[ 'Keep referral loop tight', 'Quality feedback both ways', 'Quarterly lunch' ], push:[ 'Partner landing page', 'Partner of the month', 'Joint case study' ] },
        'Autonomous':{ gentle:[ 'Leads arrive weekly', 'Measure close rate', 'Refine offer with partners' ], push:[ 'Partner program doc', 'Scale to second cluster through partners', 'Exclusive territory test' ] }
      },

      'Compliance Mastery (AU)':{
        'Seed':{ gentle:[ 'Apply/confirm ABN', 'Get public liability insurance quote', 'Open business bank account' ], push:[ 'Choose tax set‑aside % (e.g., 25%)', 'Create receipts folder structure', 'Record‑keeping checklist' ] },
        'Active':{ gentle:[ 'Register for GST if needed', 'Set monthly BAS reminder', 'Open savings for tax set‑aside' ], push:[ 'Automate set‑aside transfer', 'Do one BAS cycle solo', 'Store certificates/insurance in Drive' ] },
        'Growing':{ gentle:[ 'Document compliance workflow', 'Quarterly self‑audit', 'Keep advisor contacts' ], push:[ 'Write a 1‑page compliance SOP', 'Help a friend through their ABN', 'Benchmark insurance annually' ] },
        'Stable':{ gentle:[ 'Calendar all due dates', 'Templates for invoices/receipts', 'Backups verified' ], push:[ 'Consolidate processes', 'One‑pager “do this if audited”', 'Review with advisor yearly' ] },
        'Autonomous':{ gentle:[ 'Run system eyes‑closed', 'Teach someone else', 'Update SOP yearly' ], push:[ 'Add secondary signatory', 'Disaster recovery drill', 'Compliance pack for scale' ] }
      }
    };

    /* ===================== State ===================== */
    let ladder = loadLadder();
    ladder = migrateNames(ladder);
    store.set('lev.ladder', ladder);
    let focus = store.get('lev.focus', 0);
    let mode = store.get('lev.mode', 'gentle');

    /* ===================== Sidebar ===================== */
    function percentForMetric(m){ const done = m.milestones.filter(x=>x.completed).length; return Math.round(done / m.milestones.length * 100); }

    function renderSidebar(){
      const side = document.getElementById('sideList');
      side.innerHTML = ladder.map((m,i)=>{
        const pct = percentForMetric(m);
        const stageIdx = m.milestones.findIndex(x=>!x.completed);
        const stage = stageIdx===-1? 'Autonomous' : m.milestones[stageIdx].stage;
        return `
          <div class="metric-item ${i===focus?'active':''}" onclick="selectMetric(${i})">
            <div class="ring" style="--pct:${pct}%">${pct}%</div>
            <div class="item-text">
              <div class="item-name">${escapeHtml(m.name)}</div>
              <div class="item-sub">${escapeHtml(stage)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    /* ===================== Main ===================== */
    function renderMain(){
      const m = ladder[focus];
      const stageIdx = m.milestones.findIndex(x=>!x.completed);
      const stage = stageIdx===-1? 'Autonomous' : m.milestones[stageIdx].stage;
      const pct = percentForMetric(m);

      document.getElementById('metricTitle').textContent = m.name;
      document.getElementById('metricStage').textContent = 'Stage ' + stage;
      document.getElementById('metricWeight').textContent = 'Weight ×' + (m.weight||1);
      document.getElementById('modeBadge').textContent = 'Mode: ' + (mode==='push'?'Push':'Gentle');
      document.getElementById('metricRing').style.setProperty('--pct', pct+'%');
      document.getElementById('metricRing').textContent = pct + '%';
      document.getElementById('milestoneSummary').textContent = `${m.milestones.filter(x=>x.completed).length}/5 milestones`;

      // Overall weighted bar
      const weights = ladder.map(x=>x.weight||1);
      const scores = ladder.map(percentForMetric);
      const totalW = weights.reduce((a,b)=>a+b,0);
      const weighted = Math.round(weights.reduce((acc,w,idx)=>acc + w * scores[idx], 0) / (totalW||1));
      document.getElementById('overallFill').style.width = weighted + '%';
      document.getElementById('overallText').textContent = 'Overall independence: ' + weighted + '%';

      document.getElementById('streakBadge').textContent = 'Streak ' + computeStreak() + 'w';

      // Step engine
      currentStep = pickStep(m.name, stage);
      renderStep();

      // Evidence list
      renderEvidence();

      // Sync toggle
      document.getElementById('pushToggle').checked = (mode==='push');
    }

    function computeStreak(){
      const actions = store.get('lev.actions', []);
      function sunday(d){ const x = new Date(d); x.setHours(0,0,0,0); x.setDate(x.getDate() - x.getDay()); return x; }
      let streak=0; let check = new Date();
      for(;;){ const start=sunday(check), end=new Date(start.getTime()+7*86400000);
        const has = actions.some(a=>{ const d=new Date(a.date); return d>=start && d<end; });
        if(!has) break; streak++; check=new Date(start.getTime()-1);
      }
      return streak;
    }

    /* ===================== Step selection & completion ===================== */
    let currentStep = null;

    function getStepList(metricName, stage){
      const lib = steps[metricName]?.[stage];
      if(!lib){
        // Generic fallback
        return (mode==='push' ? {list:['Schedule a 30‑minute sprint','Invite 1 partner for accountability','Ship a visible outcome today']}
                              : {list:['Write the exact smallest move','Do a 10‑minute test','Log a one‑line proof']}).list;
      }
      return mode==='push' ? lib.push : lib.gentle;
    }

    function pickStep(metricName, stage){
      const list = getStepList(metricName, stage);
      const idx = Math.floor(Math.random()*list.length);
      return { text: list[idx], metric: metricName, stage };
    }

    function renderStep(){ document.getElementById('stepTitle').textContent = currentStep ? currentStep.text : '—'; }

    function shuffleStep(){
      const m = ladder[focus];
      const stageIdx = m.milestones.findIndex(x=>!x.completed);
      const stage = stageIdx===-1? 'Autonomous' : m.milestones[stageIdx].stage;
      currentStep = pickStep(m.name, stage); renderStep();
    }

    function completeStep(){
      if(!currentStep) return;
      // Log action
      const actions = store.get('lev.actions', []);
      actions.unshift({ date:new Date().toISOString(), metric: currentStep.metric, description: 'Step: '+ currentStep.text });
      store.set('lev.actions', actions);
      renderActions();

      // Track progression: after 4 steps at a stage, auto-complete milestone
      const key = `lev.progress.${currentStep.metric}.${currentStep.stage}`;
      const c = store.get(key, 0) + 1; store.set(key, c);
      if(c >= 4){
        const m = ladder[focus];
        const idx = m.milestones.findIndex(x=>!x.completed);
        if(idx!==-1){ m.milestones[idx].completed = true; store.set('lev.ladder', ladder); }
        store.set(key, 0);
      }

      renderSidebar();
      renderMain();
    }

    function markMilestoneIfReady(){
      const m = ladder[focus];
      const idx = m.milestones.findIndex(x=>!x.completed);
      if(idx===-1) return;
      m.milestones[idx].completed = true; store.set('lev.ladder', ladder);
      const actions = store.get('lev.actions', []);
      actions.unshift({ date:new Date().toISOString(), metric: m.name, description: 'Completed: '+ m.milestones[idx].text });
      store.set('lev.actions', actions);
      renderSidebar(); renderMain(); renderActions();
    }

    /* ===================== Evidence ===================== */
    function saveEvidenceLine(){
      const input = document.getElementById('evidenceInput');
      const text = (input.value||'').trim(); if(!text) return;
      const m = ladder[focus];
      const ev = store.get('lev.evidence', {});
      ev[m.name] = ev[m.name] || []; ev[m.name].unshift({ date:new Date().toISOString(), text });
      store.set('lev.evidence', ev); input.value='';
      const actions = store.get('lev.actions', []);
      actions.unshift({ date:new Date().toISOString(), metric: m.name, description: 'Evidence: '+ text });
      store.set('lev.actions', actions);
      renderEvidence(); renderActions();
    }

    function renderEvidence(){
      const m = ladder[focus];
      const ev = store.get('lev.evidence', {});
      const list = (ev[m.name]||[]).slice(0,4).map(e=>`<div class="log"><div class="when">${new Date(e.date).toLocaleDateString()}</div>${escapeHtml(e.text)}</div>`).join('');
      document.getElementById('evidenceList').innerHTML = list || '<div class="mini">No proof logged yet.</div>';
    }

    /* ===================== Actions ===================== */
    function renderActions(){
      const actions = store.get('lev.actions', []);
      const html = actions.length ? actions.slice(0,40).map(a=>`
        <div class="log"><div class="when">${new Date(a.date).toLocaleDateString()} · ${escapeHtml(a.metric)}</div>${escapeHtml(a.description)}</div>
      `).join('') : '<div class="mini">No actions yet.</div>';
      document.getElementById('actionList').innerHTML = html;
    }

    /* ===================== Interactions ===================== */
    function selectMetric(i){ focus = i; store.set('lev.focus', i); renderSidebar(); renderMain(); }
    function toggleMode(){ mode = document.getElementById('pushToggle').checked ? 'push' : 'gentle'; store.set('lev.mode', mode); renderMain(); }

    /* ===================== Utils ===================== */
    function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;'); }

    /* ===================== Boot ===================== */
    renderSidebar();
    renderActions();
    selectMetric(focus || 0);
  </script>
</body>
</html>
