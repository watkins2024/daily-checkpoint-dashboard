<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Independence Laboratory — Focus Mode</title>
  <style>
    /* ------------------------------------------------------
       Independence Laboratory v3 — Focus Mode (Dark)
       Goals:
       - Minimal, quiet UI (low noise)
       - One-clear-next-step per metric
       - "Gentle" vs "Push" step sequences
       - Auto-progress: finish steps → milestone completes
       - Keeps your existing localStorage data/keys
       ------------------------------------------------------ */

    :root{
      --bg: #0f1216;         /* page */
      --surface: #12161c;    /* cards */
      --muted: #8b95a7;      /* secondary text */
      --ink: #e6ebf2;        /* primary text */
      --edge: #1f2a36;       /* borders */
      --accent: #4aa8ff;     /* primary accent */
      --accent-2: #7c8cff;   /* secondary accent */
      --ok: #10b981;         /* success */
      --warn: #f59e0b;       /* warning */
      --danger: #ef4444;     /* danger */
      --ring: rgba(74,168,255,.25);
      --radius: 14px;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(80% 80% at 80% 0%, #0c0f13 0%, #0f1216 40%, #0f1216 100%);
      color: var(--ink);
    }

    a{color:var(--muted); text-decoration:none}
    .top-nav{ position:sticky; top:0; z-index:30; background:#0b0e12cc; backdrop-filter: blur(8px); border-bottom: 1px solid #0f1720; display:flex; gap:10px; padding:10px 16px }
    .top-nav a{ padding:8px 12px; border-radius:10px }
    .top-nav a:hover{ background:#12161c; color: var(--accent) }
    .top-nav a.active{ background:#12161c; color: var(--accent) }

    .shell{ display:grid; grid-template-columns: 280px 1fr; gap:16px; max-width:1200px; margin:18px auto 40px; padding:0 16px }

    /* Sidebar */
    .side{ background: var(--surface); border:1px solid var(--edge); border-radius: var(--radius); box-shadow: var(--shadow); padding:10px }
    .side h2{ font-size:14px; color:var(--muted); margin:4px 6px 10px }

    .metric-item{ display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; cursor:pointer }
    .metric-item:hover{ background:#0d131a }
    .metric-item.active{ background:#0d1520; outline: 1px solid #142033 }

    .ring{ width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-size:11px; font-weight:700; color:#9be2c2; background:
      conic-gradient(var(--ok) var(--pct,0%), #1a2533 0); }

    .item-text{ display:grid }
    .item-name{ font-size:13px }
    .item-sub{ font-size:11px; color:var(--muted) }

    /* Main */
    .main{ display:grid; gap:16px }

    .card{ background: var(--surface); border:1px solid var(--edge); border-radius: var(--radius); box-shadow: var(--shadow); padding:18px }
    .card h1{ font-size:22px; margin:0 0 4px }
    .muted{ color: var(--muted) }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .grow{ flex:1 1 280px }

    .badge{ font-size:12px; color:#a6b3c6; background:#0d1520; border:1px solid #16263a; border-radius:999px; padding:4px 10px }

    .bar{ height:12px; width:100%; background:#0e1621; border:1px solid #142033; border-radius:999px; position:relative; overflow:hidden }
    .bar-fill{ position:absolute; inset:0 auto 0 0; width:0%; background: linear-gradient(90deg, #12b886, #4aa8ff); transition: width .35s ease }
    .bar-line{ position:absolute; left:60%; top:-4px; height:20px; width:2px; background: var(--warn) }

    .seg{ display:grid; grid-template-columns: 1fr; gap:12px }

    input, textarea, select{ width:100%; padding:10px 12px; border-radius:10px; background:#0c121a; border:1px solid #142033; color:var(--ink) }
    input:focus, textarea:focus, select:focus{ outline:none; border-color: #214b7a; box-shadow: 0 0 0 3px var(--ring) }

    .btn{ background:#112136; border:1px solid #1b3a5c; color:#cfe4ff; padding:10px 14px; border-radius:10px; cursor:pointer }
    .btn:hover{ background:#0f1c2e }
    .btn-ok{ background:#0f2a22; border:1px solid #155a48; color:#bff2df }
    .btn-ghost{ background:transparent; border:1px dashed #203246; color:var(--muted) }

    .step{ background:#0c121a; border:1px solid #132035; padding:14px; border-radius:12px; display:grid; gap:8px }
    .step-title{ font-weight:700; letter-spacing:.2px }
    .step-help{ font-size:12px; color:var(--muted) }

    .mini{ font-size:12px; color:var(--muted) }

    .list{ display:grid; gap:8px }
    .log{ background:#0c121a; border:1px solid #142033; padding:10px; border-radius:10px }
    .log .when{ color:#6aa8ff; font-size:12px; margin-bottom:4px }

    .toggle{ display:flex; gap:8px; align-items:center }
    .toggle input{ width:40px; height:22px }

  </style>
</head>
<body>
  <div class="top-nav">
    <a href="index.html">← Hub</a>
    <a href="walks.html">Walks</a>
    <a href="work.html">Work</a>
    <a href="business.html">Business</a>
    <a href="leverage.html" class="active">Leverage</a>
  </div>

  <div class="shell">
    <!-- Sidebar: pick a pathway (quiet, single-column) -->
    <aside class="side">
      <h2>Your pathways</h2>
      <div id="sideList"></div>
    </aside>

    <!-- Main focus panel: ONE metric at a time -->
    <main class="main">
      <section class="card">
        <h1 id="metricTitle">—</h1>
        <div class="row">
          <span id="metricStage" class="badge">Stage —</span>
          <span id="metricWeight" class="badge">Weight ×</span>
          <span class="badge" id="modeBadge">Mode: Gentle</span>
          <span class="mini">Tip: Keep it simple. Do the next step, log a proof. Repeat.</span>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="grow">
            <div class="bar"><div id="overallFill" class="bar-fill"></div><div class="bar-line" title="Exit baseline (60%)"></div></div>
            <div class="mini" id="overallText" style="margin-top:6px">Overall independence: 0%</div>
          </div>
          <div class="badge" id="streakBadge">Streak 0w</div>
        </div>
      </section>

      <section class="card seg">
        <div class="row" style="align-items:center; justify-content: space-between">
          <div class="row" style="align-items:center">
            <div id="metricRing" class="ring" style="--pct:0%">0%</div>
            <div class="mini" id="milestoneSummary">0/5 milestones</div>
          </div>
          <label class="toggle mini">
            <input type="checkbox" id="pushToggle" onchange="toggleMode()" /> Push mode
          </label>
        </div>

        <!-- Next attainable step (auto-generated) -->
        <div class="step">
          <div class="step-title" id="stepTitle">Next step will appear here</div>
          <div class="step-help" id="stepHelp">A small, do-able move. When done, tick ✓ and (optionally) log one line of proof.</div>
          <div class="row">
            <button class="btn-ok" onclick="completeStep()">✓ I did this</button>
            <button class="btn" onclick="shuffleStep()">↻ Try another option</button>
            <button class="btn-ghost" onclick="markMilestoneIfReady()">Mark milestone ✓</button>
          </div>
          <div class="row">
            <input id="evidenceInput" placeholder="One factual line of proof (optional)" />
            <button class="btn" onclick="saveEvidenceLine()">Save proof</button>
          </div>
        </div>

        <!-- Evidence recap (last 3) -->
        <div class="list" id="evidenceList"></div>
      </section>

      <section class="card">
        <h1 style="font-size:16px; margin-bottom:8px">Recent actions</h1>
        <div id="actionList"></div>
      </section>
    </main>
  </div>

  <script>
    /* ===================== Storage ===================== */
    const store = { get(k, d){ try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)) } };

    // Keep your existing keys; add a couple for v3
    // - lev.ladder     (preserved)
    // - lev.actions    (preserved)
    // - lev.evidence   (preserved)
    // - lev.energy     (preserved)
    // - lev.thread     (preserved)
    // - lev.micro      (preserved)
    // - lev.mode       ('gentle' | 'push')
    // - lev.focus      (metric index)

    /* ===================== Default ladder ===================== */
    const defaultLadder = [
      { name:'Independent Cashflow', weight:3, milestones:[
        {stage:'Seed',    text:'Earn $50 once from non-salary work', completed:false},
        {stage:'Active',  text:'Earn $200/month for 2 months', completed:false},
        {stage:'Growing', text:'Reach 20% independent income', completed:false},
        {stage:'Stable',  text:'Reach 40% independent income', completed:false},
        {stage:'Autonomous', text:'Maintain 60%+ for 3 months', completed:false}
      ]},
      { name:'Survival Buffer', weight:3, milestones:[
        {stage:'Seed',    text:'Save $100 in separate account', completed:false},
        {stage:'Active',  text:'Build 1 month essential expenses', completed:false},
        {stage:'Growing', text:'Reach 3 months expenses', completed:false},
        {stage:'Stable',  text:'Achieve 6 months runway', completed:false},
        {stage:'Autonomous', text:'Maintain 12+ months buffer', completed:false}
      ]},
      { name:'Lean Cost Index', weight:2, milestones:[
        {stage:'Seed',    text:'Cancel one recurring payment', completed:false},
        {stage:'Active',  text:'Reduce expenses by 5%', completed:false},
        {stage:'Growing', text:'Cut costs by 10%', completed:false},
        {stage:'Stable',  text:'Achieve 20% cost reduction', completed:false},
        {stage:'Autonomous', text:'Sustain lean baseline 6+ months', completed:false}
      ]},
      { name:'Productised Value', weight:3, milestones:[
        {stage:'Seed',    text:'Write outline for one offer', completed:false},
        {stage:'Active',  text:'Create simple landing page or document', completed:false},
        {stage:'Growing', text:'Get first paying customer', completed:false},
        {stage:'Stable',  text:'Earn $100+/month from product', completed:false},
        {stage:'Autonomous', text:'Repeatable product generating revenue', completed:false}
      ]},
      { name:'Repair Capability', weight:2, milestones:[
        {stage:'Seed',    text:'Learn 1 basic repair (YouTube counts)', completed:false},
        {stage:'Active',  text:'Successfully complete 1 repair', completed:false},
        {stage:'Growing', text:'Master 2 different repair skills', completed:false},
        {stage:'Stable',  text:'Achieve 3 verified competencies', completed:false},
        {stage:'Autonomous', text:'Teach someone else a repair skill', completed:false}
      ]},
      { name:'Exchange Network', weight:2, milestones:[
        {stage:'Seed',    text:'Do one small exchange (even with friend)', completed:false},
        {stage:'Active',  text:'Establish 2 barter/trade relationships', completed:false},
        {stage:'Growing', text:'Complete 5 exchanges outside money', completed:false},
        {stage:'Stable',  text:'Build network of 5+ active partners', completed:false},
        {stage:'Autonomous', text:'Weekly exchanges are a normal routine', completed:false}
      ]},
      { name:'Systems Autonomy', weight:2, milestones:[
        {stage:'Seed',    text:'Back up one critical folder today', completed:false},
        {stage:'Active',  text:'Document one key process', completed:false},
        {stage:'Growing', text:'All files backed up in 2 places', completed:false},
        {stage:'Stable',  text:'Complete 1‑page operations manual', completed:false},
        {stage:'Autonomous', text:'Could step away for a month and it runs', completed:false}
      ]},
      { name:'Multi-Source Income', weight:3, milestones:[
        {stage:'Seed',    text:'Identify 2 potential income sources', completed:false},
        {stage:'Active',  text:'Earn from 2 different sources in one month', completed:false},
        {stage:'Growing', text:'Maintain 3 active income streams', completed:false},
        {stage:'Stable',  text:'Achieve 4+ distinct reliable payers', completed:false},
        {stage:'Autonomous', text:'No single source exceeds 40% of income', completed:false}
      ]},
      { name:'Physical Base', weight:2, milestones:[
        {stage:'Seed',    text:'Research one lower-cost location', completed:false},
        {stage:'Active',  text:'Visit or scout potential base', completed:false},
        {stage:'Growing', text:'Secure plan or lease agreement', completed:false},
        {stage:'Stable',  text:'Functional base established', completed:false},
        {stage:'Autonomous', text:'Living/working from controlled base', completed:false}
      ]},
      { name:'Compliance Mastery', weight:1, milestones:[
        {stage:'Seed',    text:'Read one BAS/tax guide', completed:false},
        {stage:'Active',  text:'Complete one form yourself', completed:false},
        {stage:'Growing', text:'Handle quarterly obligations unaided', completed:false},
        {stage:'Stable',  text:'Confident across tax/insurance processes', completed:false},
        {stage:'Autonomous', text:'Help someone else with their compliance', completed:false}
      ]},
      { name:'Strategic Redundancy', weight:1, milestones:[
        {stage:'Seed',    text:'Back up phone contacts + photos', completed:false},
        {stage:'Active',  text:'Duplicate 1 critical piece of equipment', completed:false},
        {stage:'Growing', text:'Backup power/comms solution in place', completed:false},
        {stage:'Stable',  text:'All essential gear covered', completed:false},
        {stage:'Autonomous', text:'System survives any single failure', completed:false}
      ]},
      { name:'Reflection Loop', weight:2, milestones:[
        {stage:'Seed',    text:'Write one weekly reflection', completed:false},
        {stage:'Active',  text:'Complete 4 weekly reflections in a row', completed:false},
        {stage:'Growing', text:'Identify one pattern from your notes', completed:false},
        {stage:'Stable',  text:'Weekly review becomes automatic habit', completed:false},
        {stage:'Autonomous', text:'Use reflections to guide decisions', completed:false}
      ]}
    ];

    function loadLadder(){
      const current = store.get('lev.ladder', null); if(!current) return defaultLadder;
      const byName = Object.fromEntries(defaultLadder.map(m=>[m.name, m]));
      return current.map(old=>{
        const tpl = byName[old.name] || old; // keep unknowns
        const merged = (tpl.milestones||[]).map(t=>{
          const match = (old.milestones||[]).find(o=>o.text===t.text) || {}; return {...t, completed: !!match.completed};
        });
        return { name: old.name, weight: tpl.weight||old.weight||1, milestones: merged };
      });
    }

    /* ===================== Step engine ===================== */
    // For each (metric, stage) provide small, plain-language steps (Gentle & Push).
    // Steps are intentionally tiny → consistent weekly progress.
    const steps = {
      'Independent Cashflow':{
        'Seed':{
          gentle:[ 'List 1 skill you can sell in 30 words', 'Ask 1 friend if they know someone who needs that', 'Post 1 offer in 1 place (chat/group)' ],
          push:[ 'Draft a 3-line offer and DM 3 prospects', 'Do the service free once to create a proof', 'Invoice $50 using any template' ]
        },
        'Active':{
          gentle:[ 'Pick a simple price for the month', 'Message 2 past contacts about a small paid task', 'Set 1 recurring slot in calendar for delivery' ],
          push:[ 'Publish a quick checkout (Stripe/PayPal link)', 'Book 3 micro-gigs for this month', 'Collect 1 testimonial' ]
        },
        'Growing':{
          gentle:[ 'Write a one-page result you deliver', 'Raise price by 10% on next sale', 'Bundle your offer with 1 tiny add-on' ],
          push:[ 'Pitch 5 cold leads with your 3-line script', 'Create a before/after proof page', 'Run a 2-hour sprint offer this week' ]
        },
        'Stable':{ gentle:[ 'Turn delivery into a checklist', 'Block weekly ops hour', 'Automate 1 step (invoice/template)' ], push:[ 'Launch a monthly retainer to 3 clients', 'Raise price 20% for new clients', 'Hire a helper for one task' ] },
        'Autonomous':{ gentle:[ 'Document your offer in 1 page', 'Replace yourself in 1 step', 'Review churn + retention once' ], push:[ 'Spin out a second offer', 'Run a 1‑week promotion', 'Negotiate a 3‑month prepay' ] }
      },
      'Survival Buffer':{
        'Seed':{ gentle:[ 'Open a dedicated savings space', 'Move $20 today', 'Name the account “Runway”' ], push:[ 'Move $100 today', 'Cancel 1 subscription and redirect saving', 'Sell 1 unused item and bank it' ] },
        'Active':{ gentle:[ 'Total essential bills for 1 month', 'Set weekly auto-transfer (small)', 'Track buffer total in notes' ], push:[ 'Auto-transfer 5% of income', 'Cut 1 big expense for 30 days', 'Pick a small side gig to feed buffer' ] },
        'Growing':{ gentle:[ 'Snapshot current balance', 'Add $50 this week', 'Plan the next $200' ], push:[ 'Add $200 this week', 'Bank next invoice % to buffer', 'Renegotiate 1 bill' ] },
        'Stable':{ gentle:[ 'Review interest/account safety', 'Add $50 to keep habit', 'Record months of runway' ], push:[ 'Top up to goal', 'Move excess to safe vehicle', 'Set alert if balance dips' ] },
        'Autonomous':{ gentle:[ 'Quarterly review', 'Write “rules of use”', 'Keep auto-transfer on' ], push:[ 'Increase goal by 1 month', 'Shift to higher-yield account', 'Fund 1 new resilience item' ] }
      },
      'Lean Cost Index':{
        'Seed':{ gentle:[ 'List 3 recurring charges', 'Cancel or pause 1 now', 'Switch 1 to annual save' ], push:[ 'Negotiate 1 bill on a call', 'Sell 1 unused item', 'Batch cook 3 low-cost meals' ] },
        'Active':{ gentle:[ 'Find 1 cheaper alternative', 'Lower 1 discretionary category 10%', 'Set spend alerts' ], push:[ 'No-spend weekend', 'Cut 1 category 25% for 2 weeks', 'Share plan with accountability buddy' ] },
        'Growing':{ gentle:[ 'Lock new baseline', 'Audit utilities', 'Library over buy once' ], push:[ 'Trim transport cost 15%', 'Downgrade 1 plan tier', 'Switch provider' ] },
        'Stable':{ gentle:[ 'Review every 90 days', 'Automate bills', 'Track 3-month average' ], push:[ 'Prepay to capture discount', 'Bundle services', 'Eliminate 1 whole category' ] },
        'Autonomous':{ gentle:[ 'Write your lean rules', 'Share with future you', 'Keep one treat' ], push:[ 'Model crisis budget', 'Fund crisis buffer', 'Teach someone your method' ] }
      },
      'Productised Value':{
        'Seed':{ gentle:[ 'Write the outcome you deliver in 1 sentence', 'List 3 pains your offer resolves', 'Sketch a 5‑bullet outline' ], push:[ 'Draft a 3‑screen landing page', 'Ask 3 people for feedback', 'Pre-sell to 1 buyer' ] },
        'Active':{ gentle:[ 'Publish a simple doc/page', 'Add 1 call-to-action', 'Collect 1 email' ], push:[ 'Add payment link', 'Offer a beta price to 3 people', 'Ship v1 to 1 buyer' ] },
        'Growing':{ gentle:[ 'Write a tiny FAQ', 'Add 1 proof screenshot', 'Clarify scope in bullets' ], push:[ 'Raise price 15%', 'Upsell a mini add-on', 'Collect 1 case study' ] },
        'Stable':{ gentle:[ 'Automate delivery step', 'Template your onboarding', 'Block weekly product hour' ], push:[ 'Affiliate/partner with 1 person', 'Launch a time-boxed promo', 'Bundle with your service' ] },
        'Autonomous':{ gentle:[ 'Ops checklist ready', 'Quarterly review', 'Add stop-loss rules' ], push:[ 'Second product seed', 'Licensing test', 'Raise floor price' ] }
      },
      // For brevity, remaining metrics reuse a generic pattern
    };

    function genericSteps(stage){
      const g = {
        gentle:[ 'Define the smallest move (write 1 line)', 'Do a 10‑minute test now', 'Log 1 proof line here' ],
        push:[ 'Schedule a 30‑minute sprint', 'Invite 1 person to hold you to it', 'Ship a visible outcome today' ]
      };
      return g;
    }

    // Fallback for metrics not fully specified above
    const metricNames = defaultLadder.map(m=>m.name);

    /* ===================== State ===================== */
    let ladder = loadLadder();
    store.set('lev.ladder', ladder);
    let focus = store.get('lev.focus', 0);
    let mode = store.get('lev.mode', 'gentle');

    /* ===================== Render Sidebar ===================== */
    function percentForMetric(m){ const done = m.milestones.filter(x=>x.completed).length; return Math.round(done / m.milestones.length * 100); }

    function renderSidebar(){
      const side = document.getElementById('sideList');
      side.innerHTML = ladder.map((m,i)=>{
        const pct = percentForMetric(m);
        const stageIdx = m.milestones.findIndex(x=>!x.completed);
        const stage = stageIdx===-1? 'Autonomous' : m.milestones[stageIdx].stage;
        return `
          <div class="metric-item ${i===focus?'active':''}" onclick="selectMetric(${i})">
            <div class="ring" style="--pct:${pct}%">${pct}%</div>
            <div class="item-text">
              <div class="item-name">${escapeHtml(m.name)}</div>
              <div class="item-sub">${escapeHtml(stage)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    /* ===================== Main Panel ===================== */
    function renderMain(){
      const m = ladder[focus];
      const stageIdx = m.milestones.findIndex(x=>!x.completed);
      const stage = stageIdx===-1? 'Autonomous' : m.milestones[stageIdx].stage;
      const pct = percentForMetric(m);

      document.getElementById('metricTitle').textContent = m.name;
      document.getElementById('metricStage').textContent = 'Stage ' + stage;
      document.getElementById('metricWeight').textContent = 'Weight ×' + (m.weight||1);
      document.getElementById('modeBadge').textContent = 'Mode: ' + (mode==='push'?'Push':'Gentle');
      document.getElementById('metricRing').style.setProperty('--pct', pct+'%');
      document.getElementById('metricRing').textContent = pct + '%';
      document.getElementById('milestoneSummary').textContent = `${m.milestones.filter(x=>x.completed).length}/5 milestones`;

      // Overall bar (weighted average across metrics)
      const weights = ladder.map(x=>x.weight||1);
      const scores = ladder.map(percentForMetric);
      const totalW = weights.reduce((a,b)=>a+b,0);
      const weighted = Math.round(weights.reduce((acc,w,idx)=>acc + w * scores[idx], 0) / (totalW||1));
      document.getElementById('overallFill').style.width = weighted + '%';
      document.getElementById('overallText').textContent = 'Overall independence: ' + weighted + '%';

      // Streak
      document.getElementById('streakBadge').textContent = 'Streak ' + computeStreak() + 'w';

      // Step engine
      currentStep = pickStep(m.name, stage);
      renderStep();

      // Evidence list (last 3)
      renderEvidence();

      // Sync toggle
      document.getElementById('pushToggle').checked = (mode==='push');
    }

    function computeStreak(){
      const actions = store.get('lev.actions', []);
      function sunday(d){ const x = new Date(d); x.setHours(0,0,0,0); x.setDate(x.getDate() - x.getDay()); return x; }
      let streak=0; let check = new Date();
      for(;;){ const start=sunday(check), end=new Date(start.getTime()+7*86400000);
        const has = actions.some(a=>{ const d=new Date(a.date); return d>=start && d<end; });
        if(!has) break; streak++; check=new Date(start.getTime()-1);
      }
      return streak;
    }

    /* ===================== Step selection ===================== */
    let currentStep = null;

    function getStepList(metricName, stage){
      const lib = steps[metricName]?.[stage] || genericSteps(stage);
      return (mode==='push'? lib.push : lib.gentle);
    }

    function pickStep(metricName, stage){
      const list = getStepList(metricName, stage);
      const idx = Math.floor(Math.random()*list.length);
      return { text: list[idx], metric: metricName, stage };
    }

    function renderStep(){
      document.getElementById('stepTitle').textContent = currentStep ? currentStep.text : '—';
    }

    function shuffleStep(){
      const m = ladder[focus];
      const stageIdx = m.milestones.findIndex(x=>!x.completed);
      const stage = stageIdx===-1? 'Autonomous' : m.milestones[stageIdx].stage;
      currentStep = pickStep(m.name, stage); renderStep();
    }

    function completeStep(){
      if(!currentStep) return;
      // Log action
      const actions = store.get('lev.actions', []);
      actions.unshift({ date:new Date().toISOString(), metric: currentStep.metric, description: 'Step: '+ currentStep.text });
      store.set('lev.actions', actions);
      renderActions();

      // Track micro-progression: after 3 steps in this stage, auto-complete the milestone.
      const key = `lev.progress.${currentStep.metric}.${currentStep.stage}`;
      const c = store.get(key, 0) + 1; store.set(key, c);
      if(c >= 3){
        // auto-complete current milestone
        const m = ladder[focus];
        const idx = m.milestones.findIndex(x=>!x.completed);
        if(idx!==-1){ m.milestones[idx].completed = true; store.set('lev.ladder', ladder); }
        store.set(key, 0); // reset counter for next stage
      }

      renderSidebar();
      renderMain();
    }

    function markMilestoneIfReady(){
      const m = ladder[focus];
      const idx = m.milestones.findIndex(x=>!x.completed);
      if(idx===-1) return;
      m.milestones[idx].completed = true; store.set('lev.ladder', ladder);
      const actions = store.get('lev.actions', []);
      actions.unshift({ date:new Date().toISOString(), metric: m.name, description: 'Completed: '+ m.milestones[idx].text });
      store.set('lev.actions', actions);
      renderSidebar(); renderMain(); renderActions();
    }

    /* ===================== Evidence ===================== */
    function saveEvidenceLine(){
      const input = document.getElementById('evidenceInput');
      const text = (input.value||'').trim(); if(!text) return;
      const m = ladder[focus];
      const ev = store.get('lev.evidence', {});
      ev[m.name] = ev[m.name] || []; ev[m.name].unshift({ date:new Date().toISOString(), text });
      store.set('lev.evidence', ev); input.value='';
      const actions = store.get('lev.actions', []);
      actions.unshift({ date:new Date().toISOString(), metric: m.name, description: 'Evidence: '+ text });
      store.set('lev.actions', actions);
      renderEvidence(); renderActions();
    }

    function renderEvidence(){
      const m = ladder[focus];
      const ev = store.get('lev.evidence', {});
      const list = (ev[m.name]||[]).slice(0,3).map(e=>`<div class="log"><div class="when">${new Date(e.date).toLocaleDateString()}</div>${escapeHtml(e.text)}</div>`).join('');
      document.getElementById('evidenceList').innerHTML = list || '<div class="mini">No proof logged yet.</div>';
    }

    /* ===================== Actions ===================== */
    function renderActions(){
      const actions = store.get('lev.actions', []);
      const html = actions.length ? actions.slice(0,30).map(a=>`
        <div class="log"><div class="when">${new Date(a.date).toLocaleDateString()} · ${a.metric}</div>${escapeHtml(a.description)}</div>
      `).join('') : '<div class="mini">No actions yet.</div>';
      document.getElementById('actionList').innerHTML = html;
    }

    /* ===================== Interactions ===================== */
    function selectMetric(i){ focus = i; store.set('lev.focus', i); renderSidebar(); renderMain(); }
    function toggleMode(){ mode = document.getElementById('pushToggle').checked ? 'push' : 'gentle'; store.set('lev.mode', mode); renderMain(); }

    /* ===================== Utils ===================== */
    function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

    /* ===================== Boot ===================== */
    renderSidebar();
    renderActions();
    selectMetric(focus || 0);
  </script>
</body>
</html>
